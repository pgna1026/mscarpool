<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅방</title>
    <style>
        .hidden { display: none; }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
</head>
<body>
    <h1 id="roomTitle">채팅방</h1>

    <div id="nicknameForm">
        <input type="text" id="nicknameInput" placeholder="닉네임을 입력하세요" required>
        <button id="joinChat">입장</button>
    </div>

    <div id="chatSection" class="hidden">
        <div class="messages"></div>
        <form id="chatForm">
            <input type="hidden" class="nickname" required>
            <input type="text" class="message" placeholder="메시지" required>
            <input type="submit" value="전송하기">
        </form>
    </div>

    <script>
        // Firebase 초기화
        var firebaseConfig = {
            apiKey: "AIzaSyD440GeW-QjzwjkaA9fkZ8oMtWsV-aFoPk",
            authDomain: "mscarpool-5784e.firebaseapp.com",
            projectId: "mscarpool-5784e",
            storageBucket: "mscarpool-5784e.appspot.com",
            messagingSenderId: "268039699884",
            appId: "1:268039699884:web:e88c8dc7217fb3d7c80e09"
        };
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();

        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomName = urlParams.get('room');
            const roomTitle = document.getElementById('roomTitle');
            const nicknameForm = document.getElementById('nicknameForm');
            const nicknameInput = document.getElementById('nicknameInput');
            const joinChatButton = document.getElementById('joinChat');
            const chatSection = document.getElementById('chatSection');
            const chatForm = document.getElementById('chatForm');
            const messageInput = document.querySelector('.message');
            const messagesDiv = document.querySelector('.messages');

            roomTitle.textContent = `채팅방: ${roomName}`;

            joinChatButton.addEventListener('click', function() {
                const nickname = nicknameInput.value.trim();
                if (nickname) {
                    document.querySelector('.nickname').value = nickname;
                    nicknameForm.classList.add('hidden');
                    chatSection.classList.remove('hidden');
                    loadChatHistory(roomName);
                }
            });

            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = messageInput.value.trim();
                const nickname = document.querySelector('.nickname').value;
                if (message) {
                    addMessage(roomName, nickname, message);
                    messageInput.value = '';
                    messageInput.focus();
                }
            });

            function loadChatHistory(roomName) {
                db.collection("rooms").doc(roomName).collection("messages").orderBy("timestamp").get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const msg = doc.data();
                        displayMessage(msg.nickname, msg.message);
                    });
                });
            }

            function addMessage(roomName, nickname, message) {
                const timestamp = new Date();
                db.collection("rooms").doc(roomName).collection("messages").add({
                    nickname,
                    message,
                    timestamp
                }).then(() => {
                    displayMessage(nickname, message);
                });
            }

            function displayMessage(nickname, message) {
                const messageDiv = document.createElement('div');
                messageDiv.innerHTML = `<b style='color:blue'>${nickname}</b> ${message}`;
                messagesDiv.appendChild(messageDiv);
            }
        });
    </script>
</body>
</html>
